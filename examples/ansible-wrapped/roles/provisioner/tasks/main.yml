---
- name: Ensure certificate directory exists
  file:
    path: '{{ cert_directory }}'
    state: directory

- name: Generate an OpenSSH keypair
  community.crypto.openssh_keypair:
    path: '{{ cert_directory }}/{{ cluster_name }}_ed25519'
    type: ed25519
    comment: '{{ registry_admin.email }}'
  register: keypair

- name: Apply a deployment with terraform
  community.general.terraform:
    project_path: '{{ playbook_dir }}/terraform'
    force_init: true
    overwrite_init: false
    check_destroy: true
    state: present
    variables:
      cluster_name: '{{ cluster_name }}'
      cluster_domain: '{{ cluster_domain }}'
      public_key: '{{ keypair.public_key }}'
      region: '{{ aws_region }}'
  register: terraform

- name: Add the newly provisioned hosts to the inventory
  add_host:
    name: '{{ item.name }}'
    groups: '{{ ["terraformed"] + item.groups|default([]) }}'
    ansible_host: '{{ item.hostname }}'
    ansible_user: '{{ item.user }}'
    inventory_dir: '{{ inventory_dir }}'
    ansible_ssh_private_key_file: '{{ keypair.filename }}'
    ansible_ssh_common_args: >-
      {%- if item.jump_host|default(None) != None -%}
        {{ forgettable_host + " " + proxy_command }}
      {%- else -%}
        {{ forgettable_host }}
      {%- endif -%}
  vars:
    proxy_command: >-
      -o 'ProxyCommand=ssh -W %h:%p {{ forgettable_host }} {{ item.jump_host|default(None) }}'
  changed_when: false
  loop:
  - name: registry
    groups:
    - connected
    hostname: '{{ terraform.outputs.registry_instance.value.hostname }}'
    user: '{{ terraform.outputs.registry_instance.value.username }}'
  - name: proxy
    groups:
    - connected
    hostname: '{{ terraform.outputs.proxy_instance.value.hostname }}'
    user: '{{ terraform.outputs.proxy_instance.value.username }}'
  - name: bastion
    groups:
    - disconnected
    hostname: '{{ terraform.outputs.bastion_instance.value.private_ip }}'
    user: '{{ terraform.outputs.bastion_instance.value.username }}'
    jump_host: -i "{{ keypair.filename }}" "{{ terraform.outputs.proxy_instance.value.username }}@{{ terraform.outputs.proxy_instance.value.hostname }}"

- name: Output the information we added for these hosts
  debug:
    var: hostvars|dict2items|rejectattr('key','search','controller')|list|items2dict

- name: Generate self-signed private key for proxy
  community.crypto.openssl_privatekey:
    path: '{{ cert_directory }}/squid.key'

- name: Generate self-signed certificate signing request for proxy
  community.crypto.openssl_csr:
    path: '{{ cert_directory }}/squid.csr'
    privatekey_path: '{{ cert_directory }}/squid.key'
    country_name: '{{ cert_country|default("US") }}'
    organization_name: squid
    email_address: '{{ registry_admin.email }}'
    common_name: squid
    basic_constraints:
    - CA:TRUE
    key_usage:
    - digitalSignature
    - keyEncipherment
    - dataEncipherment
    - keyAgreement
    - keyCertSign

- name: Generate self-signed certificate for proxy
  community.crypto.x509_certificate:
    path: '{{ cert_directory }}/squid.crt'
    csr_path: '{{ cert_directory }}/squid.csr'
    privatekey_path: '{{ cert_directory }}/squid.key'
    provider: selfsigned

- name: Save CA cert and key
  command: cat {{ cert_directory }}/squid.key {{ cert_directory }}/squid.crt
  changed_when: false
  register: ca
