---
name: Check

on:
  push:
  pull_request:

jobs:

  tflint:
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v2
      name: Checkout code

    - uses: actions/cache@v2
      name: Cache tflint plugins
      with:
        path: ./.tflint.d/plugins
        key: tflint-${{ hashFiles('.tflint.hcl') }}

    - uses: terraform-linters/setup-tflint@v1
      name: Setup tflint

    - uses: hashicorp/setup-terraform@v1
      name: Setup Terraform

    - name: Init terraform
      run: terraform init

    - name: Init tflint
      run: tflint --init

    - name: Run tflint
      run: tflint -f compact

  tfsec:
    runs-on: ubuntu-latest
    container: aquasec/tfsec-ci:latest
    steps:

    - name: Install git
      run: apk add git

    - uses: actions/checkout@v2
      name: Checkout code

    - name: Run tfsec
      run: tfsec .

  fmt:
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v2
      name: Checkout code

    - uses: hashicorp/setup-terraform@v1
      name: Setup Terraform

    - name: Check format
      run: terraform fmt -check
